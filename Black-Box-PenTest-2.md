# Black Box Pen Test 2 - RCM 8/25/2021
# INE 
# Scenario

You have been engaged in a Black-box Penetration Test (172.16.64.0/24 range). Your goal is to read the flag file on each machine. On some of them, you will be required to exploit a remote code execution vulnerability in order to read the flag.

# Goals 
- Discover all the machines on the network
- Read all flag files (One per machine, stored on the filesystem or within a database)
- Obtain a reverse shell at least on 172.16.64.92

# What You Will Learn 
- Taking advantage of DNS and virtual hosts
- Bypassing client-side access controls
- Abusing unrestricted file upload to achieve remote code execution

# Recommended tools
- Dirb
- Metasploit framework (recommended version 5)
- Nmap
- Sqlmap
- BurpSuite
- Text editor
---

# Procedures

1. Perform nmap discovery scan to identify alive hosts on the network. 

`nmap -sn 172.16.64.0/24`

Results:

```
Nmap scan report for 172.16.64.10
Host is up (0.000035s latency).
Nmap scan report for 172.16.64.81
Host is up (0.083s latency).
Nmap scan report for 172.16.64.91
Host is up (0.083s latency).
Nmap scan report for 172.16.64.92
Host is up (0.079s latency).
Nmap scan report for 172.16.64.166
Host is up (0.084s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 3.45 seconds
```                                                                     


2. Perform nmap service version scan, and OS detection scan.

`sudo nmap -sS -sV -v 172.16.64.10,81,91,92,166`

Results: 

![nmap_scan](https://user-images.githubusercontent.com/76081641/130802443-dfd64423-5305-4b88-a9ac-322cb9df43b6.png)

Begin with `172.16.64.166`

Recalling nmap scan.
```
PORT     STATE SERVICE VERSION
2222/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
8080/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
MAC Address: 00:50:56:A0:35:13 (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

![webpage](https://user-images.githubusercontent.com/76081641/130827211-d367aef0-3c64-4a98-926d-616dc2865a2e.png)

Intercepting requests with Burp Proxy and can see a list of users for the site.
Users: Elizabeth, Tara, Becky, Randy, Pablo, Bessie, Gerardo, Sabrina.

![users](https://user-images.githubusercontent.com/76081641/130827474-5bb12863-a7a9-4a04-a67b-4b294813ac71.png)

Attempting to connect to ssh over port 2222 as root.

`ssh root@172.16.64.199 -p 2222` and discovered what the default password is= CHANGEME

![image](https://user-images.githubusercontent.com/76081641/130828383-0749df64-42da-4da4-ad73-c001e7bbf9c6.png)

Attempt to log in with usernames found from Burp Proxy.

`ssh sabrina@172.16.64.166 -p 2222`

![image](https://user-images.githubusercontent.com/76081641/130828716-09b236a7-1e2c-4c81-8ea2-9e857ba20ece.png)

and we're in!

![image](https://user-images.githubusercontent.com/76081641/130828853-86310123-ca06-475e-880e-1914456660ef.png)

Gathering information to assist with exploiting other machines.

Hosts.bak file.
![hosts.bak](https://user-images.githubusercontent.com/76081641/130829630-d40d1721-3412-4c28-ac07-43cc131b40e3.png)

---

Use Virtual Hosts to attack 172.16.64.81.

Recalling nmap scan:

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
MAC Address: 00:50:56:A0:AD:CA (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
Add hosts to local machines config file.

![image](https://user-images.githubusercontent.com/76081641/130831562-152aca06-00d7-4ff5-90ac-3840e7e66c4c.png)


Visiting cms.foocorp.io

![image](https://user-images.githubusercontent.com/76081641/130831736-50e62ab4-ab5e-4764-86b4-bfa867b76645.png)

Actually achieved this also using dirb...

Can see directories using Burp Proxy as well.

Trying with dirb because burp is a PITA to set up. 

Discovered/robots.txt and a TON of hidden directories. This is the one we need though:


![image](https://user-images.githubusercontent.com/76081641/130833010-7c0a3f51-e72f-4ce3-a466-1670911c2d57.png)

Saving and catting the users.bak file with the credentials:
john1:password123
peter:youdonotguessthatone5

![image](https://user-images.githubusercontent.com/76081641/130833339-ee2accc2-5ebd-4c74-99f8-1689bfa7112a.png)

Attempting to log in to CMS with the found credentials.

![image](https://user-images.githubusercontent.com/76081641/130833799-46f1d315-d162-42c0-8ac5-730858fd4bc8.png)

/500.php redirect... Need to examine the redirect in burp.

![image](https://user-images.githubusercontent.com/76081641/130835406-76c425b8-1ccd-4156-9349-7cf5811783c3.png)

Database credentials are leaked in the headers.

root: x41x41x412019!

Recalling nmap scan open ports 13306.

`mysql -u root -p -P 13306 -h 172.16.64.81`

Pass:x41x41x412019!

![image](https://user-images.githubusercontent.com/76081641/130836763-e00b9f19-9d1e-43b8-91ef-8fe85bc63754.png)

Exploring database.

![image](https://user-images.githubusercontent.com/76081641/130836979-1a5b3e6d-ea03-4760-9564-a24d7112547d.png)

There's the flag.

![image](https://user-images.githubusercontent.com/76081641/130837076-9c49ed2b-74c8-4799-ac33-0815d43e2996.png)

![image](https://user-images.githubusercontent.com/76081641/130837182-b685c16a-f18f-45bb-bf8c-e90931bda4c4.png)

---

# Moving on to the DNS Server Machine.


- Target machine (DNS and virtual hosts) `172.16.64.92`

![image](https://user-images.githubusercontent.com/76081641/130801964-5a56d895-0dbb-43ab-9677-4fd4251e2be6.png)

View page source

![image](https://user-images.githubusercontent.com/76081641/130837901-167c4bff-850a-433b-9722-f2bbd7730ddc.png)

Visiting http://172.16.64.92/72ab311dcbfaa40ca0739f5daf505494/tracking2.php

![image](https://user-images.githubusercontent.com/76081641/130838092-bfd5d154-df23-4840-a030-ef38229a8382.png)

Go to tracking.php as well. http://172.16.64.92/72ab311dcbfaa40ca0739f5daf505494/tracking.php

![image](https://user-images.githubusercontent.com/76081641/130838328-3fc35252-c711-4642-af19-ea80ca295e4c.png)

The form isn't working.
http://172.16.64.92/72ab311dcbfaa40ca0739f5daf505494/tracking.php?id=2

![response](https://user-images.githubusercontent.com/76081641/130838934-052e3c04-8303-49d3-9ed8-a9a72573b96e.png)

Server is vulnerable to code injection. Check for SQLi vulnerability.

![image](https://user-images.githubusercontent.com/76081641/130839269-7b1dc46a-d8d4-4551-a4c4-78706d21e6ed.png)

It is vulnerable.

Moving to SQLMap.

`sqlmap -u http://172.16.64.92/72ab311dcbfaa40ca0739f5daf505494/tracking.php?id=2 --users`

![image](https://user-images.githubusercontent.com/76081641/130839882-3372b9ec-f49c-4187-aa6e-3a46b6070b4d.png)

`sqlmap -u http://172.16.64.92/72ab311dcbfaa40ca0739f5daf505494/tracking.php?id=2 --dump -D footracking -T users`


- Connect to 172.16.64.92 (DNS Server)

![image](https://user-images.githubusercontent.com/76081641/130804692-7b81d54c-6294-4d94-9b7d-8e89bbcd07a4.png)

- Open port 80 on `172.16.64.92:80`

![image](https://user-images.githubusercontent.com/76081641/130805603-f79bb5a5-06cc-4574-8318-f02e83ab7645.png)

- Dirb enumeration of the testing site.
